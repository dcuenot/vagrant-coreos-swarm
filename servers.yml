---

- name: ref
  box: ubuntu/trusty64
  ram: 256
  vcpu: 1
  priv_ip: 192.168.101.102
  shell: >
    # Installation de docker
    if ! command -v docr; then wget -qO- https://get.docker.com/ | sh; fi    
    # Serveur de discovery Etcd
    sudo docker run -d -ti --name etcd -p 4001:4001 -p 7001:7001 coreos/etcd || sudo docker start etcd;
    # Démarrage du manager Swarm
    sudo docker run -d -ti --name swarm -p 2121:2375 swarm manage etcd://192.168.101.102:4001/swarm || sudo docker start swarm;
    
    # démarrage de la registry
    sudo docker run -d -ti --name registry -p 5000:5000 -v /home/vagrant/registry:/tmp/registry-dev registry:2.0 || sudo docker start registry;
    # Ajout de swarm pour le rendre disponible aux autres applications
    sudo docker tag swarm ref:5000/swarm; sudo docker push ref:5000/swarm;
  
- name: prod1
  box: ubuntu/trusty64
  ram: 256
  vcpu: 1
  priv_ip: 192.168.101.120
  shell: >
    if ! command -v docr; then wget -qO- https://get.docker.com/ | sh; fi
    sudo iptables -P INPUT ACCEPT; sudo iptables -P OUTPUT ACCEPT; sudo iptables -P FORWARD ACCEPT; sudo iptables -F;
    echo '192.168.101.102 ref' | sudo tee --append /etc/hosts;
    
    sudo service docker stop;  sudo docker -H tcp://0.0.0.0:2375 -d  --insecure-registry ref:5000 &;    
    sudo docker run -d  --name swarm ref:5000/swarm join --addr=192.168.101.120:2375 etcd://192.168.101.102:4001/swarm || sudo docker start swarm;
    
  
- name: prod2
  box: ubuntu/trusty64
  ram: 256
  vcpu: 1
  priv_ip: 192.168.101.121
  shell: >
    if ! command -v docr; then wget -qO- https://get.docker.com/ | sh; fi
    echo '192.168.101.102 ref' | sudo tee --append /etc/hosts;
    echo 'DOCKER_OPTS="$DOCKER_OPTS --insecure-registry ref:5000"' | sudo tee --append /etc/default/docker;
    sudo service docker restart;
    sudo docker run -d  --name swarm ref:5000/swarm join --addr=192.168.101.121:2375 etcd://192.168.101.102:4001/swarm || sudo docker start swarm;
    sudo iptables -P INPUT ACCEPT; sudo iptables -P OUTPUT ACCEPT; sudo iptables -P FORWARD ACCEPT; sudo iptables -F;

#https://github.com/JustAdam/docker-gen-swarm